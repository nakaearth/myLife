/*
	Snow Stack 3D CSS Photo Viewer

	Copyright (C) 2009 Charles Ying. All Rights Reserved.
	This source code is available under Apache License 2.0.
	
	Performance Notes (courtesy of Apple):
		on leopard, animating transforms with a transform list > 1 function, animation falls back to software
		shadows (and animated shadows) plus border animations can cause additional redraws
		offsetWidth / offsetHeight should be avoided.
*/
// (function () {  // Module pattern
function cameraTransformForCell(a){var b=Math.floor(a/snowstack_options.rows),c=a-b*snowstack_options.rows,d=(b+.5)*CXSPACING,e=(c+.5)*CYSPACING;return magnifyMode?vfx.translate3d(-d,-e,180):vfx.translate3d(-d,-e,0)}function layoutElement(a,b,c){var d=Math.min(CHEIGHT/c,CWIDTH/b);b*=d,c*=d,a.style.width=Math.round(b)+"px",a.style.height=Math.round(c)+"px",a.style.left=Math.round((CWIDTH-b)/2)+"px",a.style.top=Math.round((CHEIGHT-c)/2)+"px"}function play_video(a){currentVideo&&!currentVideo.isPaused()&&currentVideo.setMuted(!0),currentVideo=a,currentVideo.setMuted(!1),currentVideo.play()}function html5video(a,b){var c=vfx.elem("video",{"class":"media"}),d=function(b){return layoutElement(c,c.videoWidth,c.videoHeight),a.parentNode.appendChild(c),a.parentNode.removeChild(a),!1},e=function(a){return play_video(b.video),!1};c.addEventListener("loadedmetadata",d,!1),c.addEventListener("canplay",e,!1),c.src=b.info.video,c.load(),b.video={play:function(){c.play()},pause:function(){c.pause()},isPaused:function(){return c.paused},setMuted:function(a){c.muted=a},isMuted:function(){return c.muted}}}function refreshImage(a,b){zoomTimer&&clearTimeout(zoomTimer);if(b.video){(b.video.isPaused()||b.video.isMuted())&&play_video(b.video);return}zoomTimer=setTimeout(function(){b.info.zoom&&!b.video&&(a.src=b.info.zoom),zoomTimer=null},2e3)}function setcellclass(a,b){a.div.className=b,a.reflection&&(a.reflection.className=b)}function snowstack_togglemedia(a){var b=cells[a];if(b.video){b.video.isPaused()?play_video(b.video):b.video.pause();return}b.info.videoloader?b.info.videoloader(b.divimage,b):b.info.video&&html5video(b.divimage,b)}function snowstack_update(a,b){if(currentCellIndex==a&&magnifyMode==b)return;if(currentCellIndex!=-1){var c=cells[currentCellIndex];setcellclass(c,"cell")}if(cells.length===0)return;a=Math.min(Math.max(a,0),cells.length-1),currentCellIndex=a;var d=cells[a];magnifyMode=b,magnifyMode?(newbieUser&&(newbieUser=!1),d.div.className="cell magnify",snowstack_options.refreshzoom&&refreshImage(d.divimage,d)):setcellclass(d,"cell selected"),snowstack_options.captions&&!newbieUser&&(caption.innerText=d.info.title),dolly.style.webkitTransform=cameraTransformForCell(a);var e=new WebKitCSSMatrix(document.defaultView.getComputedStyle(dolly,null).webkitTransform),f=new WebKitCSSMatrix(dolly.style.webkitTransform),g=e.m41-f.m41,h=Math.min(Math.max(g/(CXSPACING*3),-1),1)*45;camera.style.webkitTransform="rotateY("+h+"deg)",camera.style.webkitTransitionDuration="330ms",currentTimer&&clearTimeout(currentTimer),currentTimer=setTimeout(function(){camera.style.webkitTransform="rotateY(0)",camera.style.webkitTransitionDuration="5s"},330)}function snowstack_addimage(a){function g(){var a=vfx.elem("div",{"class":"cell",style:"width: "+CWIDTH+"px; height: "+CHEIGHT+"px"});return a.style.webkitTransform=vfx.translate3d(d*CXSPACING,e*CYSPACING,0),a}var b={},c=cells.length;cells.push(b);var d=Math.floor(c/snowstack_options.rows),e=c-d*snowstack_options.rows;if(typeof a=="string"){var f=a;a={thumb:f,zoom:f,title:""}}b.info=a,b.div=g(),b.divimage=vfx.elem("img",{"class":"media"}),vfx.loadhandler(b.divimage,function(){layoutElement(b.divimage,b.divimage.width,b.divimage.height),b.info.link?b.div.appendChild(vfx.elem("a",{"class":"mover view",href:b.info.link,target:"_blank"},b.divimage)):b.div.appendChild(vfx.elem("div",{"class":"mover view"},b.divimage)),b.div.style.opacity=1}),b.div.style.opacity=0,cellstack.appendChild(b.div),b.divimage.src=a.thumb,e==snowstack_options.rows-1&&(b.reflection=g(),b.reflectionimage=vfx.elem("img",{"class":"media reflection"}),vfx.loadhandler(b.reflectionimage,function(){layoutElement(b.reflectionimage,b.reflectionimage.width,b.reflectionimage.height),b.reflection.appendChild(vfx.elem("div",{"class":"mover view"},b.reflectionimage)),b.reflection.style.opacity=1}),b.reflection.style.opacity=0,reflectionstack.appendChild(b.reflection),b.reflectionimage.src=a.thumb)}function snowstack_sort(a){var b;a=="date"?b=function(a,b){var c=new Date("1 "+a.info.date),d=new Date("1 "+b.info.date);return d-c}:b=function(b,c){var d=b.info[a],e=c.info[a];return d>e?1:d<e?-1:0},cells.sort(b);for(var c=0;c<cells.length;++c){var d=Math.floor(c/snowstack_options.rows),e=c-d*snowstack_options.rows;cells[c].div.style.webkitTransform=vfx.translate3d(d*CXSPACING,e*CYSPACING,0)}}function snowstack_startsearch(){camera.style.webkitTransform="translate3d(0, 0, -500px)",camera.style.webkitTransitionDuration="1s"}function snowstack_endsearch(){camera.style.webkitTransform=""}function snowstack_search(a,b){b.length?snowstack_startsearch():snowstack_endsearch();var c=new RegExp(b,"i");for(var d=0;d<cells.length;++d){var e;b.length?e=cells[d].info[a].search(c)!=-1:e=!0,cells[d].div.style.opacity=e?1:.2}}var global=this,CWIDTH,CHEIGHT,CGAP=10,CXSPACING,CYSPACING,snowstack_options={rows:3,refreshzoom:!0,captions:!1},vfx={elem:function(a,b,c){var d=document.createElement(a);if(b)for(var e in b)b.hasOwnProperty(e)&&d.setAttribute(e,b[e]);return c&&d.appendChild(c),d},byid:function(a){return document.getElementById(a)},loadhandler:function(a,b){a.addEventListener("load",b,!1)},translate3d:function(a,b,c){return"translate3d("+a+"px, "+b+"px, "+c+"px)"}},currentCellIndex=-1,cells=[],dolly,camera,caption,cellstack,reflectionstack,magnifyMode,newbieUser=!0,zoomTimer=null,currentTimer=null,currentVideo=null;global.snowstack_init=function(a,b){function k(){var b=currentCellIndex;g.left&&b>=snowstack_options.rows&&(b-=snowstack_options.rows),g.right&&(b+snowstack_options.rows<cells.length?b+=snowstack_options.rows:c||(c=!0,a(function(a){a.forEach(snowstack_addimage),c=!1}))),g.up&&(b-=1),g.down&&(b+=1),snowstack_update(b,magnifyMode)}function l(){k(),i=setTimeout(l,j),j=60}function m(){g.left||g.right||g.up||g.down?i===null&&(j=330,l()):(clearTimeout(i),i=null)}var c=!0;camera=vfx.byid("camera"),reflectionstack=vfx.elem("div",{"class":"view"});var d=vfx.elem("div",{"class":"view"},reflectionstack);cellstack=vfx.elem("div",{"class":"view"}),dolly=vfx.elem("div",{"class":"dolly view"}),dolly.appendChild(cellstack),dolly.appendChild(d);while(camera.hasChildNodes())camera.removeChild(camera.firstChild);camera.appendChild(dolly);if(b)for(var e in b)b.hasOwnProperty(e)&&(snowstack_options[e]=b[e]);if(typeof a!="function"){var f=a;a=function(a){a(f),f=[]}}CHEIGHT=Math.round(window.innerHeight/(snowstack_options.rows+2)),CWIDTH=Math.round(CHEIGHT*300/180),CXSPACING=CWIDTH+CGAP,CYSPACING=CHEIGHT+CGAP,d.style.webkitTransform="scaleY(-1.0) "+vfx.translate3d(0,-CYSPACING*snowstack_options.rows*2-1,0),a(function(a){a.forEach(snowstack_addimage),snowstack_update(Math.floor(snowstack_options.rows/2),!1),c=!1});var g={left:!1,right:!1,up:!1,down:!1},h={37:"left",38:"up",39:"right",40:"down"},i=null,j=330;window.addEventListener("keydown",function(a){a.keyCode==32?snowstack_update(currentCellIndex,!magnifyMode):a.keyCode==13?snowstack_togglemedia(currentCellIndex):g[h[a.keyCode]]=!0,m()}),window.addEventListener("keyup",function(a){g[h[a.keyCode]]=!1,m()});var n=0,o=0,p=document.getElementById("camera");p.addEventListener("touchstart",function(a){return n=event.touches[0].pageX,o=n,a.preventDefault(),!1},!1),p.addEventListener("touchmove",function(a){o=event.touches[0].pageX;var b=o-n;return g.left=b>20,g.right=b<20,k(),n=o,a.preventDefault(),!1},!0),p.addEventListener("touchend",function(a){return g.left=!1,g.right=!1,a.preventDefault(),!1},!0)}